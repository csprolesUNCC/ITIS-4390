<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whole Foods Home</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="app.css">
    <style>
        /* Custom scrollbar styling */
        .custom-scrollbar::-webkit-scrollbar {
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(31, 41, 55, 0.5);
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(34, 197, 94, 0.5);
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(34, 197, 94, 0.7);
        }
        /* Firefox scrollbar */
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: rgba(34, 197, 94, 0.5) rgba(31, 41, 55, 0.5);
        }
        /* Line clamp utility */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div class="mobile-container">
        <!-- Cart Icon -->
        <div class="cart-icon-container">
            <a href="cart.html" class="cart-icon-button">
                <svg class="cart-icon-svg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                <span id="cart-badge" class="cart-badge" style="display: none;">0</span>
                <span id="cart-total" class="cart-total-display">$0.00</span>
            </a>
        </div>

        <div class="content-area">

            <!-- Header with logo and greeting -->
            <div class="flex items-center mb-6 bg-gradient-to-r from-green-900/50 to-green-800/30 rounded-lg p-3 border border-green-700/40">
                <div class="w-14 h-14 bg-green-700 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                    <img src="img/logo.png" alt="Whole Foods Logo" class="h-full w-full object-cover rounded-full">
                </div>
                <div class="min-w-0 flex-1">
                    <p id="home-greeting" class="text-gray-300 text-xs mb-1">Loading...</p>
                    <h1 id="home-headline" class="text-white text-xl font-semibold leading-tight">Welcome</h1>
                    <p id="home-subtitle" class="text-gray-400 text-[10px] mt-0.5 truncate">Please wait...</p>
                </div>
            </div>

            <!-- Active order banner (hidden if no active order) -->
            <div id="active-order-banner" class="hidden mb-4 px-1">
                <div class="bg-green-900/80 border border-green-600 rounded-xl p-3 flex items-start justify-between gap-3 text-xs text-white shadow-lg">
                    <div>
                        <p class="font-semibold text-sm">Order in progress</p>
                        <p id="active-order-text" class="text-[11px] text-green-100 mt-1">
                            Loading your latest order‚Ä¶
                        </p>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <button
                            id="active-order-view"
                            class="px-3 py-1 rounded-md bg-white text-green-900 font-semibold text-[11px]"
                        >
                            View details
                        </button>
                        <button
                            id="active-order-close"
                            class="text-[10px] text-green-200 underline"
                        >
                            Dismiss
                        </button>
                    </div>
                </div>
            </div>

            <!-- Guest banner -->
            <div id="guest-banner" class="mb-5 hidden">
                <div class="bg-gradient-to-r from-yellow-900/50 to-yellow-800/30 border border-yellow-700/60 text-yellow-100 rounded-lg px-4 py-3 text-xs">
                    <p class="font-semibold mb-1 text-sm">üéÅ Get personalized picks</p>
                    <p class="mb-3 text-yellow-200/90">Sign in to see items tailored to you and speed up checkout.</p>
                    <a href="login.html" class="inline-block px-4 py-1.5 rounded-md bg-yellow-500 text-black font-semibold hover:bg-yellow-400 transition-colors">Sign In</a>
                </div>
            </div>

            <!-- Dietary preferences section -->
            <section id="dietary-section" class="mb-5 hidden">
                <div class="flex items-center mb-2 px-1">
                    <h2 class="text-white text-sm font-semibold flex-1">ü•ó Your Dietary Picks</h2>
                </div>
                <p id="dietary-summary" class="text-[10px] text-gray-400 px-1 mb-3">Loading preferences‚Ä¶</p>
                <div id="dietary-products" class="flex space-x-2.5 overflow-x-auto px-1 pb-2 custom-scrollbar"></div>
            </section>

            <!-- Recommended section -->
            <section id="recommended-section" class="mb-5 hidden">
                <div class="flex items-center mb-2 px-1">
                    <h2 class="text-white text-sm font-semibold flex-1">‚ú® Recommended for You</h2>
                </div>
                <p class="text-[10px] text-gray-400 px-1 mb-3">Handpicked items we think you'll love</p>
                <div id="recommended-products" class="flex space-x-2.5 overflow-x-auto px-1 pb-2 custom-scrollbar"></div>
            </section>

            <!-- Favorite categories section -->
            <section id="favorite-categories-section" class="mb-6 hidden">
                <div class="flex items-center mb-2 px-1">
                    <h2 class="text-white text-sm font-semibold flex-1">‚≠ê Quick Access</h2>
                </div>
                <div id="favorite-categories" class="flex flex-wrap gap-2 px-1"></div>
            </section>

            <!-- Order history section -->
            <section class="mb-8">
                <div class="flex items-center mb-3 px-1">
                    <h2 class="text-white text-sm font-semibold flex-1">üì¶ Recent Orders</h2>
                    <a href="tracking.html" class="text-green-400 text-xs font-medium">View All ‚Üí</a>
                </div>

                <div class="flex space-x-3 overflow-x-auto px-1 pb-2 custom-scrollbar">
                    <a href="tracking.html" class="flex-shrink-0 w-28 h-28 bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg overflow-hidden relative shadow-lg border border-gray-700 hover:border-green-600 transition-colors">
                        <div class="grid grid-cols-2 grid-rows-2 h-full">
                            <img src="img/rotisserie_chicken.png" alt="Rotisserie Chicken" class="w-full h-full object-cover">
                            <img src="img/milk.png" alt="Milk" class="w-full h-full object-cover">
                            <img src="img/honeycrisp_apple.png" alt="Honeycrisp Apple" class="w-full h-full object-cover">
                            <img src="img/baby_spinach.png" alt="Baby Spinach" class="w-full h-full object-cover">
                        </div>
                        <div class="absolute bottom-5 left-0 bg-purple-600 text-white text-[10px] px-2 py-0.5 rounded-r font-semibold">$108.32</div>
                        <div class="absolute bottom-0 right-0 bg-black/80 text-white text-[10px] px-1.5 py-0.5 rounded-tl font-medium">10/18</div>
                    </a>

                    <div class="flex-shrink-0 w-28 h-28 bg-gradient-to-br from-green-900/40 to-green-800/20 border-2 border-dashed border-green-700/60 rounded-lg flex flex-col items-center justify-center text-center p-2">
                        <span class="text-2xl mb-1">üõí</span>
                        <p class="text-green-400 text-[10px] font-medium leading-tight">Start a new order</p>
                    </div>
                </div>
            </section>

        </div>

        <nav class="absolute bottom-0 left-0 right-0 max-w-sm mx-auto bg-green-800 text-white flex justify-around py-3">
            <a href="home.html" class="flex flex-col items-center text-xs text-green-300"><span class="text-lg">üè†</span>Home</a>
            <a href="shop.html" class="flex flex-col items-center text-xs"><span class="text-lg">üõí</span>Shop</a>
            <a href="search.html" class="flex flex-col items-center text-xs"><span class="text-lg">üîé</span>Search</a>
            <a href="profile.html" class="flex flex-col items-center text-xs"><span class="text-lg">üë§</span>Profile</a>
        </nav>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/data/supabaseAuth.js"></script>
    <script src="/data/data_api.js"></script>
    <script src="/data/orders_api.js"></script>
    <script src="cart-manager.js"></script>

    <script>
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = "flex-shrink-0 w-32 bg-gradient-to-b from-gray-800 to-gray-900 rounded-lg overflow-hidden shadow-lg border border-gray-700 hover:border-green-600 transition-all hover:shadow-green-900/20 cursor-pointer";

            const img = document.createElement('img');
            img.className = "w-full h-24 object-cover"; 
            img.src = product.image_url;
            img.alt = product.name;
            img.loading = "lazy";

            img.onerror = function() {
                this.style.display = 'none';
            };

            const body = document.createElement('div');
            body.className = "p-2.5";

            const nameEl = document.createElement('p');
            nameEl.className = "text-[11px] text-white font-medium leading-tight line-clamp-2 mb-1";
            nameEl.style.minHeight = "2.2em";
            nameEl.textContent = product.name;

            const priceEl = document.createElement('p');
            priceEl.className = "text-xs text-green-400 font-bold";
            const firstVariant = Array.isArray(product.variants) ? product.variants[0] : null;
            priceEl.textContent = firstVariant?.price_display || "";

            body.appendChild(nameEl);
            body.appendChild(priceEl);

            card.appendChild(img);
            card.appendChild(body);

            card.addEventListener('click', () => {
                window.location.href = `product.html?id=${product.id}`;
            });

            return card;
        }

        function createCategoryChip(category) {
            const chip = document.createElement('button');
            chip.type = "button";
            chip.className = "px-3 py-1.5 rounded-full text-xs font-medium bg-gradient-to-r from-gray-800 to-gray-900 text-gray-100 border border-gray-600 hover:border-green-500 hover:text-green-400 transition-all shadow-sm";
            chip.textContent = category.name || `Category #${category.id}`;
            chip.addEventListener('click', () => {
                window.location.href = `category.html?id=${category.id}`;
            });
            return chip;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const greetingEl = document.getElementById('home-greeting');
            const headlineEl = document.getElementById('home-headline');
            const subtitleEl = document.getElementById('home-subtitle');
            const guestBanner = document.getElementById('guest-banner');

            const dietarySection = document.getElementById('dietary-section');
            const dietarySummary = document.getElementById('dietary-summary');
            const dietaryProductsEl = document.getElementById('dietary-products');

            const recommendedSection = document.getElementById('recommended-section');
            const recommendedProductsEl = document.getElementById('recommended-products');

            const favoriteCategoriesSection = document.getElementById('favorite-categories-section');
            const favoriteCategoriesEl = document.getElementById('favorite-categories');

            const activeBanner = document.getElementById('active-order-banner');
            const activeText = document.getElementById('active-order-text');
            const activeViewBtn = document.getElementById('active-order-view');
            const activeCloseBtn = document.getElementById('active-order-close');

            // Load data and auth in parallel for faster loading
            const [_, session] = await Promise.all([
                DataAPI.loadEverything(),
                SupabaseAuth.getCurrentUserWithProfile()
            ]);

            if (!session || !session.user) {
                greetingEl.textContent = "Welcome";
                headlineEl.textContent = "Let's get shopping";
                subtitleEl.textContent = "Sign in to unlock personalized picks";
                guestBanner.classList.remove('hidden');
                // guests don't see the active order banner
                activeBanner.classList.add('hidden');
                return;
            }

            const { user, profile } = session;
            const displayName = profile?.name || (user.email ? user.email.split('@')[0] : "Guest");
            greetingEl.textContent = `Hey, ${displayName}! üëã`;
            headlineEl.textContent = "Your Personal Store";
            subtitleEl.textContent = user.email || "";

            // ---- Active order banner ----
            try {
                const activeOrder = await OrdersAPI.getActiveOrderForCurrentUser();

                if (activeOrder) {
                    const modeLabel = activeOrder.mode === 'pickup' ? 'Pickup' : 'Delivery';
                    const statusLabel = activeOrder.status
                        ? activeOrder.status.charAt(0).toUpperCase() + activeOrder.status.slice(1)
                        : 'In progress';
                    const windowLabel = activeOrder.window_label || 'Scheduled window not set';

                    activeText.textContent = `${modeLabel} ‚Ä¢ ${windowLabel} ‚Ä¢ Status: ${statusLabel}`;
                    activeBanner.classList.remove('hidden');

                    if (activeCloseBtn) {
                        activeCloseBtn.addEventListener('click', () => {
                            activeBanner.classList.add('hidden');
                        });
                    }

                    if (activeViewBtn) {
                        activeViewBtn.addEventListener('click', () => {
                            // For now, jump to profile/order history
                            window.location.href = 'profile.html';
                        });
                    }
                } else {
                    activeBanner.classList.add('hidden');
                }
            } catch (err) {
                console.error('[Home] active order banner error:', err);
                activeBanner.classList.add('hidden');
            }

            // ---- Dietary preferences ----
            const prefs = Array.isArray(profile?.dietary_preferences) ? profile.dietary_preferences : [];

            if (prefs.length > 0) {
                dietarySection.classList.remove('hidden');
                dietarySummary.textContent = `${prefs.join(' ¬∑ ')}`;

                const seen = new Set();
                const picks = [];

                prefs.forEach(tag => {
                    const items = DataAPI.getProductsByDiet(tag) || [];
                    items.forEach(p => {
                        if (!seen.has(p.id)) {
                            seen.add(p.id);
                            picks.push(p);
                        }
                    });
                });

                const fragment = document.createDocumentFragment();
                picks.slice(0, 8).forEach(p => fragment.appendChild(createProductCard(p)));
                dietaryProductsEl.appendChild(fragment);

                if (picks.length === 0) dietarySummary.textContent = "No matching items found yet";
            }

            // ---- Recommended products ----
            const recIds = Array.isArray(profile?.recommended_product_ids) ? profile.recommended_product_ids : [];
            if (recIds.length > 0) {
                recommendedSection.classList.remove('hidden');
                const recProducts = recIds.map(id => DataAPI.getProduct(id)).filter(Boolean);
                
                const fragment = document.createDocumentFragment();
                recProducts.slice(0, 8).forEach(p => fragment.appendChild(createProductCard(p)));
                recommendedProductsEl.appendChild(fragment);
            }

            // ---- Favorite categories ----
            const favCatIds = Array.isArray(profile?.favorite_categories) ? profile.favorite_categories : [];
            if (favCatIds.length > 0) {
                favoriteCategoriesSection.classList.remove('hidden');
                const fragment = document.createDocumentFragment();
                favCatIds.forEach(id => {
                    const cat = DataAPI.getCategory(id);
                    if (cat) fragment.appendChild(createCategoryChip(cat));
                });
                favoriteCategoriesEl.appendChild(fragment);
            }
        });
    </script>
</body>
</html>
