<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Whole Foods Shop</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="app.css">
</head>

<body class="bg-black">
  <div class="mobile-container flex flex-col">

    <div class="px-6 pt-6 pb-4 flex items-center">
      <div class="h-12 w-12 rounded-full overflow-hidden">
        <img src="img/logo.png" alt="Whole Foods Logo" class="h-full w-full object-cover">
      </div>

      <div class="ml-3">
        <h1 class="text-white text-2xl font-light">Shop</h1>
        <p id="shop-subtitle" class="text-[11px] text-gray-400 mt-1">
          Browse by aisle or search for something specific.
        </p>
      </div>
    </div>

    <div class="content-area pt-0">

      <div class="mb-6">
        <label for="search" class="sr-only">Search products</label>
        <div class="flex items-center bg-black border border-gray-700 rounded-full px-3 py-2">
          <span class="text-gray-400 mr-2">ğŸ”</span>
          <input
            id="search"
            type="text"
            placeholder="Search for products..."
            class="bg-transparent text-sm text-white placeholder:text-gray-500 flex-1 focus:outline-none"
          />
        </div>
      </div>

      <!-- Top category chips -->
      <div class="mb-6">
        <div class="flex space-x-2 overflow-x-auto pb-2 -mx-1 px-1">
          <a href="category.html" class="px-3 py-1 rounded-full text-xs font-medium bg-emerald-700 text-white flex-shrink-0">
            All
          </a>
          <a href="category.html?slug=produce" class="px-3 py-1 rounded-full text-xs font-medium bg-gray-800 text-gray-200 flex-shrink-0">
            ğŸ¥¬ Produce
          </a>
          <a href="category.html?slug=dairy-eggs" class="px-3 py-1 rounded-full text-xs font-medium bg-gray-800 text-gray-200 flex-shrink-0">
            ğŸ§€ Deli & Cheese
          </a>
          <a href="category.html?slug=meat-seafood" class="px-3 py-1 rounded-full text-xs font-medium bg-gray-800 text-gray-200 flex-shrink-0">
            ğŸ¥© Meat & Seafood
          </a>
          <a href="category.html?slug=bakery" class="px-3 py-1 rounded-full text-xs font-medium bg-gray-800 text-gray-200 flex-shrink-0">
            ğŸ Bakery
          </a>
          <a href="category.html?slug=pantry" class="px-3 py-1 rounded-full text-xs font-medium bg-gray-800 text-gray-200 flex-shrink-0">
            ğŸ¥« Pantry
          </a>
        </div>
      </div>

      <div class="mb-8">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-white text-sm font-semibold">Featured</h2>
          <span class="text-[11px] text-gray-400">Swipe to see more</span>
        </div>

        <div id="featured-products" class="flex space-x-3 overflow-x-auto pb-1 -mx-1 px-1">
        </div>
      </div>

      <div class="mt-4 mb-16">
        <h2 class="text-white text-sm font-semibold mb-3">Browse by category</h2>

        <div class="grid grid-cols-2 gap-3">
          <a href="category.html?slug=produce" class="bg-gray-900 border border-gray-800 rounded-lg p-3 flex flex-col">
            <div class="w-10 h-10 bg-emerald-800 rounded-md flex items-center justify-center mb-3">
              <span class="text-lg">ğŸ¥¬</span>
            </div>
            <p class="text-sm text-white font-medium">Produce</p>
            <p class="text-[11px] text-gray-400 leading-tight">Fresh fruits & veggies</p>
          </a>

          <a href="category.html?slug=dairy-eggs" class="bg-gray-900 border border-gray-800 rounded-lg p-3 flex flex-col">
            <div class="w-10 h-10 bg-emerald-800 rounded-md flex items-center justify-center mb-3">
              <span class="text-lg">ğŸ§€</span>
            </div>
            <p class="text-sm text-white font-medium">Deli & Cheese</p>
            <p class="text-[11px] text-gray-400 leading-tight">Cheese & prepared foods</p>
          </a>

          <a href="category.html?slug=meat-seafood" class="bg-gray-900 border border-gray-800 rounded-lg p-3 flex flex-col">
            <div class="w-10 h-10 bg-emerald-800 rounded-md flex items-center justify-center mb-3">
              <span class="text-lg">ğŸ¥©</span>
            </div>
            <p class="text-sm text-white font-medium">Meat & Seafood</p>
            <p class="text-[11px] text-gray-400 leading-tight">Fresh cuts & fish</p>
          </a>

          <a href="category.html?slug=bakery" class="bg-gray-900 border border-gray-800 rounded-lg p-3 flex flex-col">
            <div class="w-10 h-10 bg-emerald-800 rounded-md flex items-center justify-center mb-3">
              <span class="text-lg">ğŸ</span>
            </div>
            <p class="text-sm text-white font-medium">Bakery</p>
            <p class="text-[11px] text-gray-400 leading-tight">Bread & pastries</p>
          </a>

          <a href="category.html?slug=pantry" class="bg-gray-900 border border-gray-800 rounded-lg p-3 flex flex-col">
            <div class="w-10 h-10 bg-emerald-800 rounded-md flex items-center justify-center mb-3">
              <span class="text-lg">ğŸ¥«</span>
            </div>
            <p class="text-sm text-white font-medium">Pantry</p>
            <p class="text-[11px] text-gray-400 leading-tight">Staples & snacks</p>
          </a>

          <a href="category.html?slug=prepared-foods" class="bg-gray-900 border border-gray-800 rounded-lg p-3 flex flex-col">
            <div class="w-10 h-10 bg-emerald-800 rounded-md flex items-center justify-center mb-3">
              <span class="text-lg">ğŸ§¼</span>
            </div>
            <p class="text-sm text-white font-medium">Household</p>
            <p class="text-[11px] text-gray-400 leading-tight">Cleaning & home goods</p>
          </a>
        </div>
      </div>

    </div>

    <nav class="absolute bottom-0 left-0 right-0 max-w-sm mx-auto bg-green-800 text-white flex justify-around py-3">
      <a href="home.html" class="flex flex-col items-center text-xs">
        <span class="text-lg">ğŸ </span>
        Home
      </a>
      <a href="shop.html" class="flex flex-col items-center text-xs text-green-300">
        <span class="text-lg">ğŸ›’</span>
        Shop
      </a>
      <a href="search.html" class="flex flex-col items-center text-xs">
        <span class="text-lg">ğŸ”</span>
        Search
      </a>
      <a href="profile.html" class="flex flex-col items-center text-xs">
        <span class="text-lg">ğŸ‘¤</span>
        Profile
      </a>
    </nav>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/data/supabaseAuth.js"></script>
  <script src="/data/data_api.js"></script>

  <script>
    // Main product cards
    function createProductCard(product) {
      const card = document.createElement('a');
      card.href = `product.html?id=${product.id}`;
      card.className = "flex-shrink-0 w-36 bg-gray-900 rounded-xl border border-gray-800 p-3";

      const img = document.createElement('div');
      img.className = "h-20 bg-gray-700 rounded-md mb-3 flex items-center justify-center text-[10px] text-gray-300 text-center px-1";
      img.textContent = product.name;

      const nameEl = document.createElement('p');
      nameEl.className = "text-xs text-gray-300 line-clamp-2";
      nameEl.textContent = product.name;

      const priceEl = document.createElement('p');
      priceEl.className = "text-xs text-emerald-300 font-semibold mt-1";
      const variant = Array.isArray(product.variants) ? product.variants[0] : null;
      priceEl.textContent = variant?.price_display || "";

      card.appendChild(img);
      card.appendChild(nameEl);
      card.appendChild(priceEl);

      return card;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const subtitleEl = document.getElementById('shop-subtitle');
      const searchInput = document.getElementById('search');
      const featuredContainer = document.getElementById('featured-products');

      try {
        // Load catalog
        await DataAPI.loadEverything();

        // personalization
        const session = await SupabaseAuth.getCurrentUserWithProfile().catch(() => null);

        if (session && session.user) {
          const { user, profile } = session;
          const displayName =
            (profile && profile.name) ||
            (user.email ? user.email.split('@')[0] : 'there');

          subtitleEl.textContent = `For ${displayName} â€” jump back into your favorite aisles.`;
        }

        featuredContainer.innerHTML = "";

        let featuredProducts = [];

        if (session && session.profile && Array.isArray(session.profile.recommended_product_ids) && session.profile.recommended_product_ids.length) {
          featuredProducts = session.profile.recommended_product_ids
            .map(id => DataAPI.getProduct(id))
            .filter(Boolean);
        }

        if (!featuredProducts.length) {
          const fallbackIds = [101, 401, 202]; // original picks
          featuredProducts = fallbackIds
            .map(id => DataAPI.getProduct ? DataAPI.getProduct(id) : null)
            .filter(Boolean);
        }

        featuredProducts.forEach(p => {
          featuredContainer.appendChild(createProductCard(p));
        });

        searchInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            const term = searchInput.value.trim();
            if (!term) return;
            window.location.href = `search.html?q=${encodeURIComponent(term)}`;
          }
        });

      } catch (err) {
        console.error('Error loading shop page:', err);
        subtitleEl.textContent = "We couldnâ€™t load personalized content, but you can still browse categories.";
      }
    });
  </script>
</body>
</html>
