<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Delivery Tracking ¬∑ Whole Foods</title>
  <link rel="icon" type="image/png" href="img/logo.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="app.css" />
</head>
<body class="bg-black">
  <div class="mobile-container">
    <div class="content-area pb-20">
      <!-- Header -->
      <div class="flex items-center mb-4">
        <button
          type="button"
          onclick="window.location.href='home.html'"
          class="text-gray-300 text-xl mr-3"
          aria-label="Back to home"
        >
          ‚Üê
        </button>
        <div class="w-12 h-12 rounded-full flex items-center justify-center mr-3 overflow-hidden">
          <img 
            src="img/logo.png" 
            alt="Whole Foods Logo" 
            class="w-full h-full object-contain"
          />
        </div>
        <div>
          <h1 class="text-white text-2xl font-light">Delivery Status</h1>
          <p id="tracker-subtitle" class="text-gray-400 text-xs mt-1">
            Tracking your delivery order‚Ä¶
          </p>
        </div>
      </div>

      <!-- Order summary -->
      <section class="mb-6">
        <div class="header-bg text-white text-base py-2 px-3 rounded-md mb-3">
          Delivery Order
        </div>

        <div class="bg-gray-900 border border-gray-800 rounded-lg px-3 py-3 text-sm text-gray-100">
          <p class="text-emerald-300 text-xs font-semibold uppercase tracking-wide mb-1">
            Delivery Order
          </p>
          <p id="summary-window" class="text-sm font-medium">
            Window: Loading‚Ä¶
          </p>
          <p id="summary-date" class="text-[11px] text-gray-400 mt-1">
            Date: Loading‚Ä¶
          </p>
          <p id="summary-address" class="text-[11px] text-gray-400 mt-1">
            Delivering to: 1234 Smiling Friends Lane, Charlotte, NC 22222
          </p>
        </div>
      </section>

      <!-- Status steps -->
      <section class="mb-6">
        <div class="header-bg text-white text-base py-2 px-3 rounded-md mb-3">
          Delivery Progress
        </div>

        <p id="status-label" class="text-sm text-white mb-2">
          Currently: We're shopping your order
        </p>
        <p class="text-[11px] text-gray-400 mb-3">
          Your order will progress through these stages automatically.
        </p>

        <div id="status-steps" class="space-y-2">
          <!-- Steps will be rendered here -->
        </div>
      </section>

      <!-- Driver Info (Shows when out for delivery) -->
      <section class="mb-6" id="driver-section" style="display: none;">
        <div class="header-bg text-white text-base py-2 px-3 rounded-md mb-3">
          Your Driver
        </div>

        <div class="bg-gray-900 border border-gray-800 rounded-lg px-3 py-3 text-sm text-gray-100">
          <div class="flex items-center mb-3">
            <div class="w-12 h-12 bg-green-700 rounded-full flex items-center justify-center mr-3 text-white font-bold">
              JD
            </div>
            <div>
              <p class="text-white font-medium">John Doe</p>
              <p class="text-xs text-gray-400">‚≠ê 4.9 rating</p>
            </div>
          </div>
          <p class="text-xs text-gray-300">Your driver is on the way with your order!</p>
        </div>
      </section>

      <!-- Delivery Details -->
      <section class="mb-10">
        <div class="header-bg text-white text-base py-2 px-3 rounded-md mb-3">
          Delivery Details
        </div>

        <div class="bg-gray-900 border border-gray-800 rounded-lg px-3 py-3 text-xs text-gray-100">
          <p class="mb-2">
            <strong>Your Address:</strong> 1234 Smiling Friends Lane, Charlotte, NC 22222
          </p>
          <p class="mb-2 text-gray-300">
            Your driver will deliver within the selected time window. You'll receive a notification when they're nearby.
          </p>
          <p class="text-gray-400 text-[11px]">
            <strong>Special Instructions:</strong> Leave at door, ring bell
          </p>
          <div class="mt-3 h-24 bg-gray-800 rounded-md flex items-center justify-center text-[11px] text-gray-400">
            üìç Map showing delivery route
          </div>
        </div>
      </section>

      <!-- Contact Support -->
      <div class="text-center mb-6">
        <button class="text-green-500 text-sm hover:text-green-400">
          Need help? Contact Support
        </button>
      </div>
    </div>

    <!-- Bottom Nav -->
    <nav class="absolute bottom-0 left-0 right-0 max-w-sm mx-auto bg-green-800 text-white flex justify-around py-3">
            <a href="home.html" class="flex flex-col items-center text-xs text-gray-500">
                <img src="img/home-2.png" alt="Home" class="w-6 h-6 mb-1">
                Home
            </a>
            <a href="shop.html" class="flex flex-col items-center text-xs text-gray-500">
                <img src="img/shop.png" alt="Shop" class="w-6 h-6 mb-1">
                Shop
            </a>
            <a href="search.html" class="flex flex-col items-center text-xs text-gray-500">
                <img src="img/Edit Square.png" alt="Search" class="w-6 h-6 mb-1">
                Search
            </a>
            <a href="profile.html" class="flex flex-col items-center text-xs text-gray-500">
                <img src="img/profile.png" alt="Profile" class="w-6 h-6 mb-1">
                Profile
            </a>
        </nav>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/data/supabaseAuth.js"></script>
  <script src="/data/data_api.js"></script>

  <script>
    const DELIVERY_PHASES = [
      "Order placed",
      "We're shopping your order",
      "Out for delivery",
      "Delivered"
    ];

    let currentPhaseIndex = 1;

    function renderSteps(container, phases, currentIndex) {
      container.innerHTML = "";

      phases.forEach((label, index) => {
        const isCompleted = index < currentIndex;
        const isCurrent = index === currentIndex;

        const row = document.createElement("div");
        row.className = "flex items-center";

        const circle = document.createElement("div");
        circle.className =
          "w-6 h-6 flex items-center justify-center rounded-full text-[11px] mr-2 " +
          (isCompleted || isCurrent
            ? "bg-emerald-500 text-black"
            : "bg-gray-800 text-gray-400 border border-gray-600");

        circle.textContent = index + 1;

        const text = document.createElement("p");
        text.className =
          "text-xs " +
          (isCurrent
            ? "text-white font-semibold"
            : isCompleted
            ? "text-emerald-300"
            : "text-gray-400");
        text.textContent = label;

        row.appendChild(circle);
        row.appendChild(text);

        container.appendChild(row);
      });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const statusLabelEl = document.getElementById("status-label");
      const statusStepsEl = document.getElementById("status-steps");
      const driverSection = document.getElementById("driver-section");
      const summaryWindowEl = document.getElementById("summary-window");
      const summaryDateEl = document.getElementById("summary-date");

      try {
        await DataAPI.loadEverything();

        const session = await SupabaseAuth.getCurrentUserWithProfile().catch(() => null);
        let profile = session?.profile || {};
        
        // Get store and slot info
        let storeId = profile?.default_store_id || DataAPI.getStoreLocations()[0]?.id;
        let slots = storeId ? DataAPI.getDeliverySlots(storeId) : [];
        let activeSlot = slots.length ? slots[0] : null;

        if (activeSlot) {
          summaryWindowEl.textContent = `Window: ${activeSlot.window}`;
          summaryDateEl.textContent = `Date: ${activeSlot.date}`;
        } else {
          summaryWindowEl.textContent = "Window: Today, 2-4 PM";
          summaryDateEl.textContent = "Date: December 5, 2025";
        }

        // Initial render
        statusLabelEl.textContent = `Currently: ${DELIVERY_PHASES[currentPhaseIndex]}`;
        renderSteps(statusStepsEl, DELIVERY_PHASES, currentPhaseIndex);

        // Progress simulation
        setInterval(() => {
          if (currentPhaseIndex < DELIVERY_PHASES.length - 1) {
            currentPhaseIndex += 1;
            statusLabelEl.textContent = `Currently: ${DELIVERY_PHASES[currentPhaseIndex]}`;
            renderSteps(statusStepsEl, DELIVERY_PHASES, currentPhaseIndex);

            // Show driver info when out for delivery
            if (currentPhaseIndex === 2) {
              driverSection.style.display = 'block';
            }
          }
        }, 10000);

      } catch (err) {
        console.error("Error loading delivery tracker:", err);
      }
    });
  </script>
</body>
</html>
